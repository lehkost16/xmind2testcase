<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{{ name }} | Xmind2TestCase é¢„è§ˆ</title>
    <link rel="shortcut icon" href="{{ url_for('static',path='favicon.ico') }}" type="image/x-icon"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" type="text/css" media="all" href="{{ url_for('static',path='css/style.css') }}">
</head>
<body>
    <div class="header">
        <div class="content-wrapper">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                     <!-- Breadcrumb / Back -->
                    <div style="margin-bottom: 0.5rem;">
                        {% if project_id %}
                         <a href="{{ url_for('project_detail', project_id=project_id) }}" style="color: var(--text-muted); font-size: 0.9rem;">&larr; è¿”å›é¡¹ç›®</a>
                        {% else %}
                         <a href="{{ url_for('index') }}" style="color: var(--text-muted); font-size: 0.9rem;">&larr; è¿”å›é¦–é¡µ</a>
                        {% endif %}
                    </div>
                    <h1>
                        <span id="record-name-display">{{ name }}</span>
                        <input type="text" id="record-name-input" value="{{ name }}" style="display:none; width: auto;" class="input-modern">
                        <button onclick="toggleEditName()" class="btn-icon" title="é‡å‘½å">âœï¸</button>
                    </h1>
                    <h2 style="font-size: 1rem; color: var(--text-muted); font-weight: normal; margin-top: 0.5rem;">
                        æµ‹è¯•å¥—ä»¶: <strong>{{ suite_count }}</strong> &middot; æµ‹è¯•ç”¨ä¾‹: <strong>{{ suite | length }}</strong>
                    </h2>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button onclick="saveRecord()" class="btn-primary">ä¿å­˜ç»“æœ</button>
                    <button onclick="copyExecutionResults()" class="pure-button" title="å¤åˆ¶æ‰§è¡Œç»“æœæ±‡æ€»">
                        ğŸ“‹ å¤åˆ¶æ‰§è¡Œç»“æœ
                    </button>
                </div>
            </div>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                {% if settings.ENABLE_ZENTAO %}
                <a href="{{ url_for('download_zentao_file',filename= name) }}" class="btn-action">
                    <span class="btn-icon">ğŸ“Š</span>
                    <span class="btn-text">å¯¼å‡ºç¦…é“ CSV</span>
                </a>
                {% endif %}
                {% if settings.ENABLE_TESTLINK %}
                <a href="{{ url_for('download_testlink_file',filename= name) }}" class="btn-action">
                    <span class="btn-icon">ğŸ“„</span>
                    <span class="btn-text">å¯¼å‡º TestLink XML</span>
                </a>
                {% endif %}
                <a href="{{ url_for('download_xmind_file',filename= name) }}" class="btn-action">
                    <span class="btn-icon">ğŸ“¥</span>
                    <span class="btn-text">å¯¼å‡º XMind</span>
                </a>
            </div>
        </div>
    </div>

<div class="content-wrapper">
    <input type="hidden" id="record-id" value="{{ record_id }}">
    
    <div class="card" style="padding: 0; overflow: hidden;">
    <table class="pure-table tests-table" style="width: 100%; border: none; margin: 0;">
        <thead>
        <tr>
            <th width="40px" class="text-center">#</th>
            <th width="12%">æ¨¡å—/å¥—ä»¶</th>
            <th>ç”¨ä¾‹æ ‡é¢˜</th>
            <th width="100px">å±æ€§</th>
            <th width="25%">æ­¥éª¤ & é¢„æœŸ</th>
            <th width="15%">å¤‡æ³¨</th>
            <th width="10%">æ‰§è¡Œç»“æœ</th>
        </tr>
        </thead>
        <tbody>
        {% for test in suite %}
            {% set case_index = loop.index0 %}
            <tr>
                <td class="text-center">{{ loop.index }}</td>
                <td style="font-weight: 500;">{{ test.suite }}</td>
                <td>
                    <div contenteditable="true" class="editable-cell" data-index="{{ case_index }}" data-field="name" data-placeholder="è¯·è¾“å…¥ç”¨ä¾‹æ ‡é¢˜...">{{ test.name }}</div>
                    {% if test.name|length>100 %}
                        <div class="long-name-info">âš ï¸ åç§°è¿‡é•¿</div>
                    {% endif %}
                </td>
                <td>
                    <div class="tag-success">P{{ test.importance }}</div>
                    {% if test.preconditions %}
                        <div class="tooltip" style="display:inline-block; margin-top: 5px;">
                            <span class="tag-info" style="cursor:help;">å‰ç½®æ¡ä»¶</span>
                            <span class="tooltiptext">
                                <strong>å‰ç½®æ¡ä»¶:</strong><br>
                                {{ test.preconditions | replace('\n','<br>') |safe }}
                            </span>
                        </div>
                    {% endif %}
                    {% if test.summary %}
                        <div class="tooltip" style="display:inline-block; margin-top: 5px;">
                            <span class="tag-warn" style="cursor:help;">æ‘˜è¦</span>
                            <span class="tooltiptext">
                                <strong>æ‘˜è¦:</strong><br>
                                {{ test.summary | replace('\n','<br>') |safe }}
                            </span>
                        </div>
                    {% endif %}
                </td>
                <td style="font-size: 0.9em; color: #4b5563;">
                    {% if test.steps %}
                        <ol style="padding-left: 1.2rem; margin: 0;">
                            {% for step in test.steps %}
                                <li style="margin-bottom: 0.75rem;">
                                    <div contenteditable="true" class="editable-step" data-index="{{ case_index }}" data-step-index="{{ loop.index0 }}" data-type="action" data-placeholder="è¯·è¾“å…¥æµ‹è¯•æ­¥éª¤...">{{ step.actions }}</div>
                                    {% if step.expectedresults %}
                                        <div style="font-style: italic; color: #6b7280; margin-top: 4px; display: flex; align-items: flex-start;">
                                            <span style="margin-right: 8px; color: #94a3b8; font-weight: bold; margin-top: 6px;">&rdsh;</span>
                                            <div contenteditable="true" class="editable-step" data-index="{{ case_index }}" data-step-index="{{ loop.index0 }}" data-type="expected" style="flex: 1;" data-placeholder="è¯·è¾“å…¥é¢„æœŸç»“æœ...">{{ step.expectedresults }}</div>
                                        </div>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ol>
                    {% else %}
                        <ol style="padding-left: 1.2rem; margin: 0;"></ol>
                    {% endif %}
                    <button class="btn-add-step" onclick="addStep({{ case_index }}, this)">
                        <span>â•</span> å¢åŠ æ­¥éª¤
                    </button>
                </td>
                <td>
                     <div contenteditable="true" class="editable-cell" data-index="{{ case_index }}" data-field="comment" data-placeholder="å¤‡æ³¨..." style="min-height: 2rem; color: #6b7280; font-size: 0.9rem;">{{ test.comment or '' }}</div>
                </td>
                <td>
                    <select class="result-select input-modern" data-index="{{ loop.index0 }}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-bottom: 0.25rem;">
                        <option value="Not Run" {% if test.result == 'Not Run' %}selected{% endif %}>æœªæ‰§è¡Œ</option>
                        <option value="Pass" {% if test.result == 'Pass' %}selected{% endif %}>é€šè¿‡</option>
                        <option value="Fail" {% if test.result == 'Fail' %}selected{% endif %}>å¤±è´¥</option>
                        <option value="Block" {% if test.result == 'Block' %}selected{% endif %}>é˜»å¡</option>
                        <option value="Skip" {% if test.result == 'Skip' %}selected{% endif %}>è·³è¿‡</option>
                    </select>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>

</div>

<style>
    .editable-cell, .editable-step {
        padding: 6px 10px;
        border: 1.5px solid transparent;
        border-radius: 6px;
        transition: all 0.2s ease;
        background-color: transparent;
        cursor: text;
    }

    .editable-cell:hover, .editable-step:hover {
        background-color: #f8fafc;
        border-color: #e2e8f0;
    }

    .editable-cell:focus, .editable-step:focus {
        border-color: var(--primary-color) !important;
        background-color: #ffffff;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        outline: none;
        z-index: 10;
        position: relative;
    }

    [contenteditable=true]:empty:before {
        content: attr(data-placeholder);
        color: #94a3b8;
        font-style: italic;
    }

    .tests-table td {
        vertical-align: top;
        padding: 1.25rem 1rem;
    }

    .editable-cell[data-field="name"] {
        font-weight: 600;
        color: #1e293b;
        font-size: 1.05rem;
    }

    .editable-step {
        font-size: 0.95rem;
        line-height: 1.5;
        margin-bottom: 2px;
    }

    .result-select {
        height: 32px;
        min-width: 100px;
    }

    .btn-add-step {
        background: #f1f5f9;
        border: 1px dashed #cbd5e1;
        color: #64748b;
        padding: 0.4rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        margin-top: 0.75rem;
    }

    .btn-add-step:hover {
        background: #e2e8f0;
        color: var(--primary-color);
        border-style: solid;
        border-color: var(--primary-color);
    }
</style>

<script>
    const recordId = document.getElementById('record-id').value;
    const testCases = {{ suite | tojson | safe }};
    
    // Ensure all test cases have a comment field
    testCases.forEach(tc => {
        if (!tc.hasOwnProperty('comment')) {
            tc.comment = '';
        }
    });

    function toggleEditName() {
        const display = document.getElementById('record-name-display');
        const input = document.getElementById('record-name-input');
        if (input.style.display === 'none') {
            input.style.display = 'inline-block';
            display.style.display = 'none';
            input.focus();
            input.select(); // Select all text for easy editing
        } else {
            saveNameOnly(); // Auto-save when toggling back to display mode
        }
    }

    function saveNameOnly() {
        if (!recordId || recordId === 'None') {
            alert("No record ID found. Cannot save.");
            return;
        }

        const display = document.getElementById('record-name-display');
        const input = document.getElementById('record-name-input');
        const newName = input.value.trim();

        if (!newName) {
            alert('æ–‡ä»¶åä¸èƒ½ä¸ºç©º');
            input.value = display.innerText; // Restore original name
            return;
        }

        // Update display immediately for better UX
        input.style.display = 'none';
        display.innerText = newName;
        display.style.display = 'inline';

        // Save to backend
        fetch(`/api/records/${recordId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: newName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show brief success indicator
                const originalColor = display.style.color;
                display.style.color = '#10b981';
                setTimeout(() => {
                    display.style.color = originalColor;
                }, 1000);
            } else {
                alert('ä¿å­˜æ–‡ä»¶åå¤±è´¥');
                // Could revert the display here if needed
            }
        })
        .catch(err => {
            console.error(err);
            alert('ä¿å­˜æ–‡ä»¶åæ—¶å‡ºé”™');
        });
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    const performAutoSave = debounce(() => {
        const btn = document.querySelector('button[onclick="saveRecord()"]');
        const originalText = "ä¿å­˜ç»“æœ"; // Default text
        // Don't override if already showing success message
        if (btn.innerText !== 'å·²ä¿å­˜!') {
             btn.innerText = "è‡ªåŠ¨ä¿å­˜ä¸­...";
        }

        saveRecordData()
            .then(() => {
                const date = new Date();
                const timeStr = date.getHours().toString().padStart(2, '0') + ':' + 
                                date.getMinutes().toString().padStart(2, '0') + ':' + 
                                date.getSeconds().toString().padStart(2, '0');
                
                // Update button or show a small toast
                btn.innerText = "å·²è‡ªåŠ¨ä¿å­˜ (" + timeStr + ")";
                btn.style.color = "#10b981";
                
                // Revert style slightly but keep the timestamp text for assurance
                setTimeout(() => {
                     btn.style.color = "";
                     // Optional: revert to "Save Results" after a long while or keep showing last saved time
                }, 3000);
            })
            .catch(err => {
                console.error("Auto-save failed:", err);
                btn.innerText = "è‡ªåŠ¨ä¿å­˜å¤±è´¥";
                btn.style.color = "#ef4444";
            });
    }, 1000); // Debounce for 1 second

    // Attach Auto-Save Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // ... existing name input listeners ...
        const input = document.getElementById('record-name-input');
        
        // Save on Enter key
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                toggleEditName();
            } else if (e.key === 'Escape') {
                // Cancel editing on Escape
                const display = document.getElementById('record-name-display');
                input.value = display.innerText; // Restore original value
                input.style.display = 'none';
                display.style.display = 'inline';
            }
        });

        // Save on blur (clicking outside)
        input.addEventListener('blur', function() {
            // Small delay to allow click events to process first
            setTimeout(() => {
                if (input.style.display !== 'none') {
                    toggleEditName();
                }
            }, 100);
        });

        // --- New Auto-Save Bindings ---
        const table = document.querySelector('.tests-table');
        
        // Use delegation for better performance and handling dynamic elements (like new steps)
        table.addEventListener('input', function(e) {
            if (e.target.isContentEditable) {
                performAutoSave();
            }
        });

        table.addEventListener('change', function(e) {
            if (e.target.classList.contains('result-select')) {
                performAutoSave();
            }
        });
    });

    function collectData() {
         const newName = document.getElementById('record-name-input').value;
        const resultSelects = document.querySelectorAll('.result-select');
        const nameCells = document.querySelectorAll('.editable-cell[data-field="name"]');
        const commentCells = document.querySelectorAll('.editable-cell[data-field="comment"]');
        const editableSteps = document.querySelectorAll('.editable-step');
        
        // Update Results
        resultSelects.forEach(select => {
            const index = select.getAttribute('data-index');
            testCases[index].result = select.value;
        });

        // Update Titles
        nameCells.forEach(cell => {
             const index = cell.getAttribute('data-index');
             testCases[index].name = cell.innerText.trim();
        });

        // Update Comments
        commentCells.forEach(cell => {
             const index = cell.getAttribute('data-index');
             testCases[index].comment = cell.innerText.trim();
        });

        // Update Steps
        editableSteps.forEach(stepDiv => {
             const caseIndex = stepDiv.getAttribute('data-index');
             const stepIndex = stepDiv.getAttribute('data-step-index');
             const type = stepDiv.getAttribute('data-type');
             
             if (testCases[caseIndex] && testCases[caseIndex].steps && testCases[caseIndex].steps[stepIndex]) {
                 if (type === 'action') {
                     testCases[caseIndex].steps[stepIndex].actions = stepDiv.innerText.trim();
                 } else if (type === 'expected') {
                     testCases[caseIndex].steps[stepIndex].expectedresults = stepDiv.innerText.trim();
                 }
             }
        });
        
        return { newName, content: testCases };
    }

    function saveRecordData() {
        return new Promise((resolve, reject) => {
            if (!recordId || recordId === 'None') {
                reject("No record ID found. Cannot save.");
                return;
            }

            const data = collectData();

            fetch(`/api/records/${recordId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: data.newName,
                    content: data.content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('record-name-display').innerText = collectData().newName;
                    resolve(data);
                } else {
                    reject('ä¿å­˜å¤±è´¥');
                }
            })
            .catch(err => {
                console.error(err);
                reject('Error saving.');
            });
        });
    }

    function saveRecord() {
        const btn = document.querySelector('button[onclick="saveRecord()"]');
        const originalText = btn.innerText;
        btn.innerText = "ä¿å­˜ä¸­...";
        
        saveRecordData()
            .then(() => {
                btn.innerText = "å·²ä¿å­˜!";
                btn.style.background = "#10b981"; 
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = "";
                }, 2000);
            })
            .catch(err => {
                alert(err);
                btn.innerText = originalText;
            });
    }

    function addStep(caseIndex, btn) {
        // Ensure steps array exists
        if (!testCases[caseIndex].steps) {
            testCases[caseIndex].steps = [];
        }
        
        const stepIndex = testCases[caseIndex].steps.length;
        const newStep = {
            step_number: stepIndex + 1,
            actions: "",
            expectedresults: "",
            execution_type: 1
        };
        testCases[caseIndex].steps.push(newStep);

        // Find the OL or create one if it doesn't exist (though template handles checking if steps exist, if empty list initially...)
        let ol = btn.previousElementSibling;
        if (ol.tagName !== 'OL') {
             // Handle obscure case where OL might be missing
             console.warn("OL element not found for adding step");
        }

        const li = document.createElement('li');
        li.style.marginBottom = "0.5rem";
        
        li.innerHTML = `
            <div contenteditable="true" class="editable-step" data-index="${caseIndex}" data-step-index="${stepIndex}" data-type="action" data-placeholder="è¯·è¾“å…¥æµ‹è¯•æ­¥éª¤..."></div>
            <div style="font-style: italic; color: #6b7280; margin-top: 4px; display: flex; align-items: flex-start;">
                <span style="margin-right: 8px; color: #94a3b8; font-weight: bold; margin-top: 6px;">&rdsh;</span>
                <div contenteditable="true" class="editable-step" data-index="${caseIndex}" data-step-index="${stepIndex}" data-type="expected" style="flex: 1;" data-placeholder="è¯·è¾“å…¥é¢„æœŸç»“æœ..."></div>
            </div>
        `;
        
        if (ol) ol.appendChild(li);
    }

    function copyExecutionResults() {
        if (!recordId || recordId === 'None') return;
        
        const btn = document.querySelector('button[onclick="copyExecutionResults()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = "â³ å¤„ç†ä¸­...";

        // Auto-save before copying to ensure data is fresh
        saveRecordData()
            .then(() => {
                return fetch(`/api/records/${recordId}/export`);
            })
            .then(res => res.text())
            .then(text => {
                // Copy to clipboard
                navigator.clipboard.writeText(text).then(() => {
                    btn.innerHTML = "âœ… å·²å¤åˆ¶";
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                }, (err) => {
                    console.error('Could not copy text: ', err);
                    alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸‹è½½");
                    btn.innerHTML = originalText;
                });
            })
            .catch(err => {
                console.error(err);
                alert("æ“ä½œå¤±è´¥: " + err);
                btn.innerHTML = originalText;
            });
    }
</script>
</body>
</html>