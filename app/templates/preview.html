<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{{ name }} | Xmind2TestCase é¢„è§ˆ</title>
    <link rel="shortcut icon" href="{{ url_for('static',path='favicon.ico') }}" type="image/x-icon"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" type="text/css" media="all" href="{{ url_for('static',path='css/style.css') }}">
</head>
<body>
    <div class="header">
        <div class="content-wrapper">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                     <!-- Breadcrumb / Back -->
                    <div style="margin-bottom: 0.5rem;">
                        {% if project_id %}
                         <a href="{{ url_for('project_detail', project_id=project_id) }}" style="color: var(--text-muted); font-size: 0.9rem;">&larr; è¿”å›é¡¹ç›®</a>
                        {% else %}
                         <a href="{{ url_for('index') }}" style="color: var(--text-muted); font-size: 0.9rem;">&larr; è¿”å›é¦–é¡µ</a>
                        {% endif %}
                    </div>
                    <h1>
                        <span id="record-name-display">{{ name }}</span>
                        <input type="text" id="record-name-input" value="{{ name }}" style="display:none; width: auto;" class="input-modern">
                        <button onclick="toggleEditName()" class="btn-icon" title="é‡å‘½å">âœï¸</button>
                    </h1>
                    <h2 style="font-size: 1rem; color: var(--text-muted); font-weight: normal; margin-top: 0.5rem;">
                        æµ‹è¯•å¥—ä»¶: <strong>{{ suite_count }}</strong> &middot; åŠŸèƒ½æ¨¡å—: <strong>{{ suite | length }}</strong>
                    </h2>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button onclick="saveRecord()" class="btn-primary">ä¿å­˜ç»“æœ</button>
                    <button onclick="copyExecutionResults()" class="pure-button" title="å¤åˆ¶æ‰§è¡Œç»“æœæ±‡æ€»">
                        ğŸ“‹ å¤åˆ¶æ‰§è¡Œç»“æœ
                    </button>
                </div>
            </div>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                {% if settings.ENABLE_ZENTAO %}
                <a href="#" onclick="exportWithFilter('zentao')" class="btn-action">
                    <span class="btn-icon">ğŸ“Š</span>
                    <span class="btn-text">å¯¼å‡ºç¦…é“ CSV</span>
                </a>
                {% endif %}
                {% if settings.ENABLE_TESTLINK %}
                <a href="#" onclick="exportWithFilter('testlink')" class="btn-action">
                    <span class="btn-icon">ğŸ“„</span>
                    <span class="btn-text">å¯¼å‡º TestLink XML</span>
                </a>
                {% endif %}
                <a href="#" onclick="exportWithFilter('xmind')" class="btn-action">
                    <span class="btn-icon">ğŸ“¥</span>
                    <span class="btn-text">å¯¼å‡º XMind</span>
                </a>
            </div>
            
        </div>
    </div>

<div class="content-wrapper">
    <input type="hidden" id="record-id" value="{{ record_id }}">
    
    <div class="card" style="padding: 0; overflow: hidden;">
    <table class="pure-table tests-table" style="width: 100%; border: none; margin: 0;">
        <thead>
        <tr>
            <th width="32px" class="text-center">
                <label class="checkbox-container" style="padding-left: 18px;">
                    <input type="checkbox" id="select-all-cases" checked onchange="toggleAllCases(this)">
                    <span class="checkmark" style="height: 16px; width: 16px;"></span>
                </label>
            </th>
            <th width="40px" class="text-center">#</th>
            <th width="10%">æ¨¡å—/å¥—ä»¶</th>
            <th>ç”¨ä¾‹æ ‡é¢˜</th>
            <th width="120px">å±æ€§</th>
            <th width="25%">æ­¥éª¤ & é¢„æœŸ</th>
            <th width="15%">å¤‡æ³¨</th>
            <th width="10%">æ‰§è¡Œç»“æœ</th>
        </tr>
        </thead>
        <tbody>
        {% for test in suite %}
            {% set case_index = loop.index0 %}
            <tr>
                <td class="text-center">
                    <label class="checkbox-container" style="padding-left: 18px;">
                        <input type="checkbox" class="case-checkbox" value="{{ case_index }}" checked onchange="updateSelectAllStatus()">
                        <span class="checkmark" style="height: 16px; width: 16px;"></span>
                    </label>
                </td>
                <td class="text-center">{{ loop.index }}</td>
                <td style="font-weight: 500;">{{ test.suite }}</td>
                <td>
                    <div style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 4px;">
                        <span style="font-size: 0.75rem; color: var(--text-muted); padding-top: 4px;">ID:</span>
                        <div contenteditable="true" class="editable-cell tc-id-cell" data-index="{{ case_index }}" data-field="tc_id" data-placeholder="æœªè®¾ç½® ID" 
                             style="font-size: 0.85rem; color: var(--primary-color); font-family: monospace; min-width: 60px;"
                             oninput="updateBindingStatus(this, {{ case_index }})">{{ test.tc_id or '' }}</div>
                        <span class="binding-tag" data-index="{{ case_index }}">
                            {% if test.tc_id and test.tc_id in automation_bindings %}
                                <span class="tag-success" style="font-size: 0.7rem; padding: 2px 6px; white-space: nowrap;" title="å·²ç»‘å®š">å·²ç»‘å®š</span>
                            {% elif test.tc_id %}
                                <span class="tag-info" style="font-size: 0.7rem; padding: 2px 6px; white-space: nowrap; background-color: #f1f5f9; color: #64748b;" title="æœªç»‘å®š">æœªç»‘å®š</span>
                            {% endif %}
                        </span>
                    </div>
                    <div contenteditable="true" class="editable-cell" data-index="{{ case_index }}" data-field="name" data-placeholder="è¯·è¾“å…¥ç”¨ä¾‹æ ‡é¢˜..." style="font-weight: 600; color: #1e293b; font-size: 1.05rem;">{{ test.name }}</div>
                    {% if test.name|length>100 %}
                        <div class="long-name-info">âš ï¸ åç§°è¿‡é•¿</div>
                    {% endif %}
                </td>
                <td>
                    <div class="tag-success">P{{ test.importance }}</div>
                    {% if test.preconditions %}
                        <div class="tooltip" style="display:inline-block; margin-top: 5px;">
                            <span class="tag-info" style="cursor:help;">å‰ç½®æ¡ä»¶</span>
                            <span class="tooltiptext">
                                <strong>å‰ç½®æ¡ä»¶:</strong><br>
                                {{ test.preconditions | replace('\n','<br>') |safe }}
                            </span>
                        </div>
                    {% endif %}
                    {% if test.summary %}
                        <div class="tooltip" style="display:inline-block; margin-top: 5px;">
                            <span class="tag-warn" style="cursor:help;">æ‘˜è¦</span>
                            <span class="tooltiptext">
                                <strong>æ‘˜è¦:</strong><br>
                                {{ test.summary | replace('\n','<br>') |safe }}
                            </span>
                        </div>
                    {% endif %}
                </td>
                <td style="font-size: 0.9em; color: #4b5563;">
                    {% if test.steps %}
                        <ol style="padding-left: 1.2rem; margin: 0;">
                            {% for step in test.steps %}
                                <li class="step-item">
                                    <div class="step-content">
                                        <div style="display: flex; gap: 8px; align-items: flex-start; justify-content: space-between;">
                                            <span class="step-number">{{ loop.index }}.</span>
                                            <div contenteditable="true" class="editable-step" data-index="{{ case_index }}" data-step-index="{{ loop.index0 }}" data-type="action" data-placeholder="è¯·è¾“å…¥æµ‹è¯•æ­¥éª¤..." style="flex: 1;">{{ step.actions }}</div>
                                            <div style="display: flex; gap: 4px; align-items: center; margin-top: 4px;">
                                                <button class="step-status-btn status-{{ step.status | default('not_run') }}" 
                                                        onclick="cycleStepStatus(this, {{ case_index }}, {{ loop.index0 }})"
                                                        title="ç‚¹å‡»åˆ‡æ¢çŠ¶æ€: æœªæ‰§è¡Œ -> é€šè¿‡ -> å¤±è´¥">
                                                    {% if step.status == 'pass' %}
                                                        âœ“
                                                    {% elif step.status == 'fail' %}
                                                        âœ•
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </button>
                                                <button class="btn-icon delete-step-btn" onclick="deleteStep({{ case_index }}, {{ loop.index0 }})" title="åˆ é™¤æ­¥éª¤">
                                                    ğŸ—‘ï¸
                                                </button>
                                            </div>
                                        </div>
                                        <div style="font-style: italic; color: #6b7280; margin-top: 4px; display: flex; align-items: flex-start;">
                                            <span style="margin-right: 8px; color: #94a3b8; font-weight: bold; margin-top: 6px;">&rdsh;</span>
                                            <div contenteditable="true" class="editable-step" data-index="{{ case_index }}" data-step-index="{{ loop.index0 }}" data-type="expected" style="flex: 1;" data-placeholder="è¯·è¾“å…¥é¢„æœŸç»“æœ...">{{ step.expectedresults }}</div>
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ol>
                    {% else %}
                        <ol style="padding-left: 1.2rem; margin: 0;"></ol>
                    {% endif %}
                    <button class="btn-add-step" onclick="addStep({{ case_index }}, this)">
                        <span>â•</span> å¢åŠ æ­¥éª¤
                    </button>
                </td>
                <td>
                     <div contenteditable="true" class="editable-cell" data-index="{{ case_index }}" data-field="comment" data-placeholder="å¤‡æ³¨..." style="min-height: 2rem; color: #6b7280; font-size: 0.9rem;">{{ test.comment or '' }}</div>
                </td>
                <td>
                    <select class="result-select input-modern" data-index="{{ loop.index0 }}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-bottom: 0.25rem;">
                        <option value="Not Run" {% if test.result == 'Not Run' %}selected{% endif %}>æœªæ‰§è¡Œ</option>
                        <option value="Pass" {% if test.result == 'Pass' %}selected{% endif %}>é€šè¿‡</option>
                        <option value="Fail" {% if test.result == 'Fail' %}selected{% endif %}>å¤±è´¥</option>
                        <option value="Block" {% if test.result == 'Block' %}selected{% endif %}>é˜»å¡</option>
                        <option value="Skip" {% if test.result == 'Skip' %}selected{% endif %}>è·³è¿‡</option>
                    </select>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>
    <input type="hidden" id="_initial_load_marker">
    <script>
        // Ensure DOM is fully loaded before checking/migrating data
        // This is a small helper to handle legacy data if needed
    </script>
    </div>

</div>

<style>
    .editable-cell, .editable-step {
        padding: 6px 10px;
        border: 1.5px solid transparent;
        border-radius: 6px;
        transition: all 0.2s ease;
        background-color: transparent;
        cursor: text;
    }

    .editable-cell:hover, .editable-step:hover {
        background-color: #f8fafc;
        border-color: #e2e8f0;
    }

    .editable-cell:focus, .editable-step:focus {
        border-color: var(--primary-color) !important;
        background-color: #ffffff;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        outline: none;
        z-index: 10;
        position: relative;
    }

    [contenteditable=true]:empty:before {
        content: attr(data-placeholder);
        color: #94a3b8;
        font-style: italic;
    }

    .tests-table td {
        vertical-align: top;
        padding: 1.25rem 1rem;
    }

    .tc-id-cell:hover {
        background-color: #f1f5f9;
        border-bottom: 1px dashed var(--primary-color);
    }

    .editable-step {
        font-size: 0.95rem;
        line-height: 1.5;
        margin-bottom: 2px;
    }

    .result-select {
        height: 32px;
        min-width: 100px;
    }

    .btn-add-step {
        background: #f1f5f9;
        border: 1px dashed #cbd5e1;
        color: #64748b;
        padding: 0.4rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        margin-top: 0.75rem;
    }

    .btn-add-step:hover {
        background: #e2e8f0;
        color: var(--primary-color);
        border-style: solid;
        border-color: var(--primary-color);
    }

    .step-number {
        color: #374151; /* Darker grey for better visibility */
        font-weight: 600;
        min-width: 1.2em;
        padding-top: 2px;
        flex-shrink: 0;
    }

    .delete-step-btn {
        font-size: 0.9rem;
        padding: 2px 6px;
        opacity: 0.6;
        transition: opacity 0.2s;
    }

    .delete-step-btn:hover {
        opacity: 1;
        background-color: #fee2e2;
        color: #ef4444;
    }

    /* Module Filter Card Styles */
    .module-filter-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 1.25rem;
        margin-top: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .suites-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        max-height: 200px;
        overflow-y: auto;
        padding: 4px;
    }

    /* Custom Checkbox Styles */
    .checkbox-container {
        display: flex;
        align-items: center;
        position: relative;
        padding-left: 30px;
        cursor: pointer;
        font-size: 0.9rem;
        user-select: none;
        color: var(--text-color);
        transition: color 0.2s;
    }

    .checkbox-container:hover {
        color: var(--primary-color);
    }

    .checkbox-container input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .checkmark {
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 18px;
        width: 18px;
        background-color: #f1f5f9;
        border: 1.5px solid #cbd5e1;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .checkbox-container:hover input ~ .checkmark {
        border-color: var(--primary-color);
        background-color: #f8fafc;
    }

    .checkbox-container input:checked ~ .checkmark {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }

    .checkbox-container input:checked ~ .checkmark:after {
        display: block;
    }

    .checkbox-container .checkmark:after {
        left: 6px;
        top: 2px;
        width: 4px;
        height: 9px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    .suite-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Back to Top Button */
    .back-to-top-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 44px;
        height: 44px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
    }

    .back-to-top-btn:hover {
        transform: translateY(-5px);
        background-color: #2563eb;
        box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.4);
    }

    .back-to-top-btn svg {
        transition: transform 0.3s;
    }

    .back-to-top-btn:hover svg {
        transform: scale(1.1);
    }
</style>

<script>
    const recordId = document.getElementById('record-id').value;
    const testCases = {{ suite | tojson | safe }};
    const automationBindings = {{ (automation_bindings | default([])) | tojson | safe }};
    const filename = "{{ name }}";

    function toggleAllCases(masterCheckbox) {
        const checkboxes = document.querySelectorAll('.case-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = masterCheckbox.checked;
        });
    }

    function updateSelectAllStatus() {
        const checkboxes = document.querySelectorAll('.case-checkbox');
        const selectAll = document.getElementById('select-all-cases');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        const someChecked = Array.from(checkboxes).some(cb => cb.checked);
        
        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;
    }

    function exportWithFilter(type) {
        const selectedIndices = Array.from(document.querySelectorAll('.case-checkbox:checked'))
                                    .map(cb => cb.value);
        
        if (selectedIndices.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç”¨ä¾‹è¿›è¡Œå¯¼å‡º');
            return;
        }

        let url = "";
        if (type === 'zentao') {
            url = `/${filename}/to/zentao`;
        } else if (type === 'testlink') {
            url = `/${filename}/to/testlink`;
        } else if (type === 'xmind') {
            url = `/${filename}/to/xmind`;
        }

        const query = new URLSearchParams();
        query.append('cases', selectedIndices.join(','));
        url += `?${query.toString()}`;

        window.location.href = url;
    }

    
    // Ensure all test cases have a comment field and steps have status
    testCases.forEach(tc => {
        if (!tc.hasOwnProperty('comment')) {
            tc.comment = '';
        }
        if (tc.steps) {
            tc.steps.forEach(step => {
                if (!step.status) step.status = 'not_run';
            });
        }
    });

    // Step Status Logic
    const STEP_STATUS_MAP = {
        'not_run': { next: 'pass', icon: '-', class: 'status-not_run', title: 'æœªæ‰§è¡Œ' },
        'pass':    { next: 'fail', icon: 'âœ“', class: 'status-pass',    title: 'é€šè¿‡' },
        'fail':    { next: 'not_run', icon: 'âœ•', class: 'status-fail', title: 'å¤±è´¥' }
    };

    function cycleStepStatus(btn, caseIndex, stepIndex) {
        // Find current status
        let currentStatus = 'not_run';
        if (btn.classList.contains('status-pass')) currentStatus = 'pass';
        else if (btn.classList.contains('status-fail')) currentStatus = 'fail';
        
        const nextStatusKey = STEP_STATUS_MAP[currentStatus].next;
        const nextStatus = STEP_STATUS_MAP[nextStatusKey];

        // Update UI
        btn.className = `step-status-btn ${nextStatus.class}`;
        btn.innerText = nextStatus.icon;
        
        // Update Data
        if (testCases[caseIndex] && testCases[caseIndex].steps && testCases[caseIndex].steps[stepIndex]) {
            testCases[caseIndex].steps[stepIndex].status = nextStatusKey;
        }

        // Trigger Auto Save
        performAutoSave();
    }

    function toggleEditName() {
        const display = document.getElementById('record-name-display');
        const input = document.getElementById('record-name-input');
        if (input.style.display === 'none') {
            input.style.display = 'inline-block';
            display.style.display = 'none';
            input.focus();
            input.select(); // Select all text for easy editing
        } else {
            saveNameOnly(); // Auto-save when toggling back to display mode
        }
    }

    function saveNameOnly() {
        if (!recordId || recordId === 'None') {
            alert("No record ID found. Cannot save.");
            return;
        }

        const display = document.getElementById('record-name-display');
        const input = document.getElementById('record-name-input');
        const newName = input.value.trim();

        if (!newName) {
            alert('æ–‡ä»¶åä¸èƒ½ä¸ºç©º');
            input.value = display.innerText; // Restore original name
            return;
        }

        // Update display immediately for better UX
        input.style.display = 'none';
        display.innerText = newName;
        display.style.display = 'inline';

        // Save to backend
        fetch(`/api/records/${recordId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: newName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show brief success indicator
                const originalColor = display.style.color;
                display.style.color = '#10b981';
                setTimeout(() => {
                    display.style.color = originalColor;
                }, 1000);
            } else {
                alert('ä¿å­˜æ–‡ä»¶åå¤±è´¥');
                // Could revert the display here if needed
            }
        })
        .catch(err => {
            console.error(err);
            alert('ä¿å­˜æ–‡ä»¶åæ—¶å‡ºé”™');
        });
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    const performAutoSave = debounce(() => {
        const btn = document.querySelector('button[onclick="saveRecord()"]');
        const originalText = "ä¿å­˜ç»“æœ"; // Default text
        // Don't override if already showing success message
        if (btn.innerText !== 'å·²ä¿å­˜!') {
             btn.innerText = "è‡ªåŠ¨ä¿å­˜ä¸­...";
        }

        saveRecordData()
            .then(() => {
                const date = new Date();
                const timeStr = date.getHours().toString().padStart(2, '0') + ':' + 
                                date.getMinutes().toString().padStart(2, '0') + ':' + 
                                date.getSeconds().toString().padStart(2, '0');
                
                // Update button or show a small toast
                btn.innerText = "å·²è‡ªåŠ¨ä¿å­˜ (" + timeStr + ")";
                btn.style.color = "#10b981";
                
                // Revert style slightly but keep the timestamp text for assurance
                setTimeout(() => {
                     btn.style.color = "";
                     // Optional: revert to "Save Results" after a long while or keep showing last saved time
                }, 3000);
            })
            .catch(err => {
                console.error("Auto-save failed:", err);
                btn.innerText = "è‡ªåŠ¨ä¿å­˜å¤±è´¥";
                btn.style.color = "#ef4444";
            });
    }, 1000); // Debounce for 1 second

    // Attach Auto-Save Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // ... existing name input listeners ...
        const input = document.getElementById('record-name-input');
        
        // Save on Enter key
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                toggleEditName();
            } else if (e.key === 'Escape') {
                // Cancel editing on Escape
                const display = document.getElementById('record-name-display');
                input.value = display.innerText; // Restore original value
                input.style.display = 'none';
                display.style.display = 'inline';
            }
        });

        // Save on blur (clicking outside)
        input.addEventListener('blur', function() {
            // Small delay to allow click events to process first
            setTimeout(() => {
                if (input.style.display !== 'none') {
                    toggleEditName();
                }
            }, 100);
        });

        // --- New Auto-Save Bindings ---
        const table = document.querySelector('.tests-table');
        
        // Use delegation for better performance and handling dynamic elements (like new steps)
        table.addEventListener('input', function(e) {
            if (e.target.isContentEditable) {
                performAutoSave();
            }
        });

        table.addEventListener('change', function(e) {
            if (e.target.classList.contains('result-select')) {
                performAutoSave();
            }
        });

        // Back to Top Logic
        const backToTopBtn = document.getElementById('back-to-top');
        if (backToTopBtn) {
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    backToTopBtn.style.display = 'flex';
                } else {
                    backToTopBtn.style.display = 'none';
                }
            });

            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }
    });

    function collectData() {
        const newName = document.getElementById('record-name-input').value;
        const resultSelects = document.querySelectorAll('.result-select');
        const nameCells = document.querySelectorAll('.editable-cell[data-field="name"]');
        const commentCells = document.querySelectorAll('.editable-cell[data-field="comment"]');
        const tcIdCells = document.querySelectorAll('.editable-cell[data-field="tc_id"]');
        const editableSteps = document.querySelectorAll('.editable-step');
        
        // Update Results
        resultSelects.forEach(select => {
            const index = select.getAttribute('data-index');
            testCases[index].result = select.value;
        });

        // Update Titles
        nameCells.forEach(cell => {
             const index = cell.getAttribute('data-index');
             testCases[index].name = cell.innerText.trim();
        });

        // Update TC_IDs
        tcIdCells.forEach(cell => {
             const index = cell.getAttribute('data-index');
             testCases[index].tc_id = cell.innerText.trim();
        });

        // Update Comments
        commentCells.forEach(cell => {
             const index = cell.getAttribute('data-index');
             testCases[index].comment = cell.innerText.trim();
        });

        // Update Steps
        editableSteps.forEach(stepDiv => {
             const caseIndex = stepDiv.getAttribute('data-index');
             const stepIndex = stepDiv.getAttribute('data-step-index');
             const type = stepDiv.getAttribute('data-type');
             
             if (testCases[caseIndex] && testCases[caseIndex].steps && testCases[caseIndex].steps[stepIndex]) {
                 if (type === 'action') {
                     testCases[caseIndex].steps[stepIndex].actions = stepDiv.innerText.trim();
                 } else if (type === 'expected') {
                     testCases[caseIndex].steps[stepIndex].expectedresults = stepDiv.innerText.trim();
                 }
             }
        });
        
        return { newName, content: testCases };
    }

    function updateBindingStatus(cell, index) {
        const newId = cell.innerText.trim();
        const tagContainer = document.querySelector(`.binding-tag[data-index="${index}"]`);
        
        if (!newId) {
            tagContainer.innerHTML = '';
            return;
        }

        if (automationBindings.includes(newId)) {
            tagContainer.innerHTML = '<span class="tag-success" style="font-size: 0.7rem; padding: 2px 6px; white-space: nowrap;" title="å·²å‘ç°åŒ¹é…çš„ä»£ç ">å·²ç»‘å®š</span>';
        } else {
            tagContainer.innerHTML = '<span class="tag-info" style="font-size: 0.7rem; padding: 2px 6px; white-space: nowrap; background-color: #f1f5f9; color: #64748b;" title="ä»£ç åº“ä¸­æœªæ‰¾åˆ°æ­¤ ID">æœªç»‘å®š</span>';
        }
    }

    function saveRecordData() {
        return new Promise((resolve, reject) => {
            if (!recordId || recordId === 'None') {
                reject("No record ID found. Cannot save.");
                return;
            }

            const data = collectData();

            fetch(`/api/records/${recordId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: data.newName,
                    content: data.content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('record-name-display').innerText = collectData().newName;
                    resolve(data);
                } else {
                    reject('ä¿å­˜å¤±è´¥');
                }
            })
            .catch(err => {
                console.error(err);
                reject('Error saving.');
            });
        });
    }

    function saveRecord() {
        const btn = document.querySelector('button[onclick="saveRecord()"]');
        const originalText = btn.innerText;
        btn.innerText = "ä¿å­˜ä¸­...";
        
        saveRecordData()
            .then(() => {
                btn.innerText = "å·²ä¿å­˜!";
                btn.style.background = "#10b981"; 
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = "";
                }, 2000);
            })
            .catch(err => {
                alert(err);
                btn.innerText = originalText;
            });
    }

    function addStep(caseIndex, btn) {
        // Ensure steps array exists
        if (!testCases[caseIndex].steps) {
            testCases[caseIndex].steps = [];
        }
        
        const stepIndex = testCases[caseIndex].steps.length;
        const newStep = {
            step_number: stepIndex + 1,
            actions: "",
            expectedresults: "",
            execution_type: 1,
            status: "not_run"
        };
        testCases[caseIndex].steps.push(newStep);

        // Find the OL or create one if it doesn't exist (though template handles checking if steps exist, if empty list initially...)
        let ol = btn.previousElementSibling;
        if (ol.tagName !== 'OL') {
             // Handle obscure case where OL might be missing
             console.warn("OL element not found for adding step");
        }

        const li = document.createElement('li');
        li.className = "step-item";
        
        li.innerHTML = `
            <div class="step-content">
                <div style="display: flex; gap: 8px; align-items: flex-start; justify-content: space-between;">
                    <span class="step-number">${stepIndex + 1}.</span>
                    <div contenteditable="true" class="editable-step" data-index="${caseIndex}" data-step-index="${stepIndex}" data-type="action" data-placeholder="è¯·è¾“å…¥æµ‹è¯•æ­¥éª¤..." style="flex: 1;"></div>
                    <div style="display: flex; gap: 4px; align-items: center; margin-top: 4px;">
                        <button class="step-status-btn status-not_run" 
                                onclick="cycleStepStatus(this, ${caseIndex}, ${stepIndex})"
                                title="ç‚¹å‡»åˆ‡æ¢çŠ¶æ€: æœªæ‰§è¡Œ -> é€šè¿‡ -> å¤±è´¥">
                            -
                        </button>
                        <button class="btn-icon delete-step-btn" onclick="deleteStep(${caseIndex}, ${stepIndex})" title="åˆ é™¤æ­¥éª¤">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
                <div style="font-style: italic; color: #6b7280; margin-top: 4px; display: flex; align-items: flex-start;">
                    <span style="margin-right: 8px; color: #94a3b8; font-weight: bold; margin-top: 6px;">&rdsh;</span>
                    <div contenteditable="true" class="editable-step" data-index="${caseIndex}" data-step-index="${stepIndex}" data-type="expected" style="flex: 1;" data-placeholder="è¯·è¾“å…¥é¢„æœŸç»“æœ..."></div>
                </div>
            </div>
        `;
        if (ol) ol.appendChild(li);
    }

    function deleteStep(caseIndex, stepIndex) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ­¥éª¤å—ï¼Ÿ')) return;

        // Remove from data source
        if (testCases[caseIndex] && testCases[caseIndex].steps) {
            testCases[caseIndex].steps.splice(stepIndex, 1);
        }

        // Re-render the steps list for this test case
        const tableRow = document.querySelectorAll('tbody tr')[caseIndex]; 
        // Note: Using loop index for tableRow might be fragile if sorted/filtered, 
        // but currently preview.html renders sequentially. 
        // A safer way is to find the OL with a specific ID or relative traverse.
        
        // Actually, easiest way is to reload page or just update DOM carefully.
        // Let's force a reload for now? No, bad UX.
        // Let's rebuild the OL content.
        
        const ol = tableRow.querySelector('ol');
        ol.innerHTML = '';
        
        // Re-populate steps
        if (testCases[caseIndex].steps) {
            testCases[caseIndex].steps.forEach((step, idx) => {
                const li = document.createElement('li');
                li.className = "step-item";
                
                // Determine Status Icon/Class
                let statusClass = 'status-not_run';
                let statusIcon = '-';
                if (step.status === 'pass') { statusClass = 'status-pass'; statusIcon = 'âœ“'; }
                else if (step.status === 'fail') { statusClass = 'status-fail'; statusIcon = 'âœ•'; }

                li.innerHTML = `
                    <div class="step-content">
                        <div style="display: flex; gap: 8px; align-items: flex-start; justify-content: space-between;">
                            <span class="step-number">${idx + 1}.</span>
                            <div contenteditable="true" class="editable-step" data-index="${caseIndex}" data-step-index="${idx}" data-type="action" data-placeholder="è¯·è¾“å…¥æµ‹è¯•æ­¥éª¤..." style="flex: 1;">${step.actions || ''}</div>
                            <div style="display: flex; gap: 4px; align-items: center; margin-top: 4px;">
                                <button class="step-status-btn ${statusClass}" 
                                        onclick="cycleStepStatus(this, ${caseIndex}, ${idx})"
                                        title="ç‚¹å‡»åˆ‡æ¢çŠ¶æ€: æœªæ‰§è¡Œ -> é€šè¿‡ -> å¤±è´¥">
                                    ${statusIcon}
                                </button>
                                <button class="btn-icon delete-step-btn" onclick="deleteStep(${caseIndex}, ${idx})" title="åˆ é™¤æ­¥éª¤">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                        <div style="font-style: italic; color: #6b7280; margin-top: 4px; display: flex; align-items: flex-start;">
                            <span style="margin-right: 8px; color: #94a3b8; font-weight: bold; margin-top: 6px;">&rdsh;</span>
                            <div contenteditable="true" class="editable-step" data-index="${caseIndex}" data-step-index="${idx}" data-type="expected" style="flex: 1;" data-placeholder="è¯·è¾“å…¥é¢„æœŸç»“æœ...">${step.expectedresults || ''}</div>
                        </div>
                    </div>
                `;
                ol.appendChild(li);
            });
        }
        
        performAutoSave();
    }

    function copyExecutionResults() {
        if (!recordId || recordId === 'None') return;
        
        const btn = document.querySelector('button[onclick="copyExecutionResults()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = "â³ å¤„ç†ä¸­...";

        // Auto-save before copying to ensure data is fresh
        saveRecordData()
            .then(() => {
                return fetch(`/api/records/${recordId}/export`);
            })
            .then(res => res.text())
            .then(text => {
                // Copy to clipboard with fallback
                const copyToClipboard = (str) => {
                    // Try modern API first (if available and secure context)
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        return navigator.clipboard.writeText(str);
                    }
                    // Fallback for non-secure contexts or older browsers
                    return new Promise((resolve, reject) => {
                        try {
                            const textArea = document.createElement("textarea");
                            textArea.value = str;
                            
                            // Ensure it's not visible but part of the DOM
                            textArea.style.position = "fixed";
                            textArea.style.left = "-9999px";
                            textArea.style.top = "0";
                            document.body.appendChild(textArea);
                            
                            textArea.focus();
                            textArea.select();
                            
                            const successful = document.execCommand('copy');
                            document.body.removeChild(textArea);
                            
                            if (successful) resolve();
                            else reject(new Error("Browser does not support copy"));
                        } catch (err) {
                            reject(err);
                        }
                    });
                };

                copyToClipboard(text).then(() => {
                    btn.innerHTML = "âœ… å·²å¤åˆ¶";
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                }).catch((err) => {
                    console.error('Could not copy text: ', err);
                    alert("å¤åˆ¶å¤±è´¥ï¼Œæ‚¨çš„æµè§ˆå™¨æš‚ä¸æ”¯æŒè‡ªåŠ¨å¤åˆ¶ï¼Œè¯·å°è¯•æ‰‹åŠ¨ä¸‹è½½æ–‡ä»¶ã€‚");
                    btn.innerHTML = originalText;
                });
            })
            .catch(err => {
                console.error(err);
                alert("æ“ä½œå¤±è´¥: " + err);
                btn.innerHTML = originalText;
            });
    }
</script>
    <button id="back-to-top" class="back-to-top-btn" title="å›åˆ°é¡¶éƒ¨">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
    </button>
</body>
</html>