<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç³»ç»Ÿé…ç½® | Xmind2TestCase</title>
    <link rel="shortcut icon" href="{{ url_for('static',path='favicon.ico') }}" type="image/x-icon"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" type="text/css" media="all" href="{{ url_for('static',path='css/style.css') }}">
    <style>
        .config-section {
            margin-bottom: 2.5rem;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
        }
        .config-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .config-card h3 {
            margin-top: 0;
            font-size: 1.1rem;
            color: #1e293b;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 0.75rem;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .config-hint {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        .switch-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .switch-group:last-child {
            border-bottom: none;
        }
        .switch-label {
            font-weight: 500;
            color: #334155;
        }
        .btn-save-all {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            border-radius: 50px;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5);
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand"><h1>X2T</h1></div>
            <nav>
                <a href="{{ url_for('index') }}" class="nav-item">
                    <span class="icon">ğŸ </span> é¦–é¡µä»ªè¡¨ç›˜
                </a>
                <a href="{{ url_for('manage_projects') }}" class="nav-item">
                    <span class="icon">ğŸ“‚</span> é¡¹ç›®ç®¡ç†
                </a>
                <a href="{{ url_for('manage_configs') }}" class="nav-item active">
                    <span class="icon">âš™ï¸</span> ç³»ç»Ÿé…ç½®
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h2>ç³»ç»Ÿå…¨å±€é…ç½®</h2>
            </header>

            <form id="config-form" class="content-wrapper">
                <div class="config-grid">
                    <!-- Case Types -->
                    <div class="config-card">
                        <h3><span>ğŸ·ï¸</span> ç”¨ä¾‹ç±»å‹ç®¡ç†</h3>
                        <p class="config-hint">ç®¡ç†æ”¯æŒçš„ç”¨ä¾‹ç±»å‹ã€‚ç‚¹å‡»â€œæ·»åŠ â€æŒ‰é’®åŠ å…¥æ–°é¡¹ï¼Œç‚¹å‡»é¡¹æ—çš„â€œ&times;â€åˆ é™¤ã€‚</p>
                        <div class="tag-manager" id="case_types_manager">
                            <div class="tag-container" id="case_types_tags"></div>
                            <div class="tag-input-group">
                                <input type="text" class="input-modern" placeholder="è¾“å…¥ç±»å‹åç§°..." onkeydown="if(event.key==='Enter'){addTag('case_types');event.preventDefault();}">
                                <button type="button" class="btn-primary" onclick="addTag('case_types')">æ·»åŠ </button>
                            </div>
                        </div>
                        <input type="hidden" name="case_types" value="{{ configs.case_types }}">
                    </div>

                    <!-- Apply Phases -->
                    <div class="config-card">
                        <h3><span>ğŸ“…</span> åº”ç”¨é˜¶æ®µç®¡ç†</h3>
                        <p class="config-hint">ç®¡ç†æµ‹è¯•æµç¨‹ä¸­çš„å¯¹åº”é˜¶æ®µã€‚</p>
                        <div class="tag-manager" id="apply_phases_manager">
                            <div class="tag-container" id="apply_phases_tags"></div>
                            <div class="tag-input-group">
                                <input type="text" class="input-modern" placeholder="è¾“å…¥é˜¶æ®µåç§°..." onkeydown="if(event.key==='Enter'){addTag('apply_phases');event.preventDefault();}">
                                <button type="button" class="btn-primary" onclick="addTag('apply_phases')">æ·»åŠ </button>
                            </div>
                        </div>
                        <input type="hidden" name="apply_phases" value="{{ configs.apply_phases }}">
                    </div>

                    <!-- Project List -->
                    <div class="config-card">
                        <h3><span>ğŸ“</span> é¢„è®¾é¡¹ç›®ç®¡ç†</h3>
                        <p class="config-hint">åœ¨è¿™é‡Œé¢„è®¾é¡¹ç›®åç§°ã€‚æ·»åŠ åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨â€œé¡¹ç›®ç®¡ç†â€åŠé¦–é¡µä¸‹æ‹‰æ¡†ä¸­ç”Ÿæˆè¯¥é¡¹ç›®ã€‚</p>
                        <div class="tag-manager" id="projects_manager">
                            <div class="tag-container" id="projects_tags"></div>
                            <div class="tag-input-group">
                                <input type="text" class="input-modern" placeholder="è¾“å…¥é¡¹ç›®åç§°..." onkeydown="if(event.key==='Enter'){addTag('projects');event.preventDefault();}">
                                <button type="button" class="btn-primary" onclick="addTag('projects')">æ·»åŠ </button>
                            </div>
                        </div>
                        <input type="hidden" name="projects" value="{{ configs.projects }}">
                    </div>

                    <!-- Switches -->
                    <div class="config-card">
                        <h3><span>ğŸ”Œ</span> åŠŸèƒ½ç»„ä»¶å¼€å…³</h3>
                        <p class="config-hint">æ§åˆ¶å…¨å±€å¯¼å‡ºåŠŸèƒ½çš„å¯ç”¨æ€§ã€‚</p>
                        
                        <div class="switch-group">
                            <span class="switch-label">å¼€å¯ç¦…é“å¯¼å‡º (CSV)</span>
                            <input type="checkbox" name="enable_zentao" value="1" {% if configs.enable_zentao == '1' %}checked{% endif %}>
                        </div>
                        
                        <div class="switch-group">
                            <span class="switch-label">å¼€å¯ TestLink å¯¼å‡º (XML)</span>
                            <input type="checkbox" name="enable_testlink" value="1" {% if configs.enable_testlink == '1' %}checked{% endif %}>
                        </div>
                    </div>
                </div>

                <button type="button" onclick="saveConfigs()" class="btn-primary btn-save-all">
                    ğŸ’¾ ä¿å­˜å…¨å±€é…ç½®
                </button>
            </form>
        </main>
    </div>

    <script>
        // Tag management state
        const configData = {
            case_types: "{{ configs.case_types }}".split(',').filter(i => i.trim()),
            apply_phases: "{{ configs.apply_phases }}".split(',').filter(i => i.trim()),
            projects: "{{ configs.projects }}".split(',').filter(i => i.trim())
        };

        const protectedTags = [
            'åŠŸèƒ½æµ‹è¯•', 'æ¥å£æµ‹è¯•', 'æ€§èƒ½æµ‹è¯•', 'å®‰å…¨æµ‹è¯•', 'é…ç½®ç›¸å…³', 'å®‰è£…å¸è½½', 'å•å…ƒæµ‹è¯•', 'å…¶ä»–',
            'å•å…ƒæµ‹è¯•é˜¶æ®µ', 'åŠŸèƒ½æµ‹è¯•é˜¶æ®µ', 'é›†æˆæµ‹è¯•é˜¶æ®µ', 'ç³»ç»Ÿæµ‹è¯•é˜¶æ®µ', 'éªŒæ”¶æµ‹è¯•é˜¶æ®µ', 'å†’çƒŸæµ‹è¯•é˜¶æ®µ'
        ];

        function renderTags(name) {
            const container = document.getElementById(`${name}_tags`);
            container.innerHTML = '';
            configData[name].forEach((tag, index) => {
                const isProtected = protectedTags.includes(tag.trim());
                const badge = document.createElement('div');
                badge.className = 'tag-badge';
                if (isProtected) {
                    badge.style.background = '#f1f5f9';
                    badge.style.borderColor = '#e2e8f0';
                    badge.title = 'ç³»ç»Ÿå†…ç½®é¡¹ï¼Œä¸å¯åˆ é™¤';
                }
                badge.innerHTML = `
                    <span>${tag}</span>
                    ${isProtected ? '' : `<span class="remove-tag" onclick="removeTag('${name}', ${index})">&times;</span>`}
                `;
                container.appendChild(badge);
            });
            // Update hidden input
            document.querySelector(`input[name="${name}"]`).value = configData[name].join(',');
        }

        function addTag(name) {
            const input = document.querySelector(`#${name}_manager input`);
            const rawVal = input.value.trim();
            if (!rawVal) return;

            // æ”¯æŒé€—å·åˆ†éš”æ‰¹é‡æ·»åŠ 
            const items = rawVal.split(/[,ï¼Œ]/).map(i => i.trim()).filter(i => i);
            let hasDuplicate = false;

            items.forEach(val => {
                // ä¸åˆ†å¤§å°å†™çš„å»é‡æ ¡éªŒ
                const isDup = configData[name].some(existing => existing.toLowerCase() === val.toLowerCase());
                if (!isDup) {
                    configData[name].push(val);
                } else {
                    hasDuplicate = true;
                }
            });

            if (hasDuplicate) {
                showToast('éƒ¨åˆ†æˆ–å…¨éƒ¨é¡¹å·²å­˜åœ¨ï¼Œå·²è‡ªåŠ¨è¿‡æ»¤é‡å¤å†…å®¹', 'warning');
            }

            renderTags(name);
            input.value = '';
            input.focus();
        }



        function removeTag(name, index) {
            const tagValue = configData[name][index];
            
            // ä¿æŠ¤å†…ç½®é¡¹
            if (protectedTags.includes(tagValue)) {
                showToast(`â€œ${tagValue}â€ æ˜¯ç³»ç»Ÿå†…ç½®é¡¹ï¼Œä¸æ”¯æŒåˆ é™¤`, 'warning');
                return;
            }

            // é¡¹ç›®åˆ é™¤äºŒæ¬¡ç¡®è®¤ï¼ˆé’ˆå¯¹å¯èƒ½å­˜åœ¨æ•°æ®çš„é¡¹ç›®ï¼‰
            if (name === 'projects') {
                if (!confirm(`ç¡®å®šè¦åœ¨é…ç½®åˆ—è¡¨ä¸­ç§»é™¤é¡¹ç›® â€œ${tagValue}â€ å—ï¼Ÿ\nå¦‚æœè¯¥é¡¹ç›®ä¸‹å­˜åœ¨æµ‹è¯•è®°å½•ï¼Œä¿å­˜é…ç½®æ—¶å°†ä¼šæŠ¥é”™æ‹¦æˆªã€‚`)) {
                    return;
                }
            }

            configData[name].splice(index, 1);
            renderTags(name);
        }

        // Initialize
        ['case_types', 'apply_phases', 'projects'].forEach(renderTags);

        function showToast(message, type = 'success') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} show`;
            const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸' };
            toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><span class="toast-message">${message}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function saveConfigs() {
            const form = document.getElementById('config-form');
            const formData = new FormData(form);
            const data = {};
            
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            data['enable_zentao'] = form.querySelector('[name="enable_zentao"]').checked ? '1' : '0';
            data['enable_testlink'] = form.querySelector('[name="enable_testlink"]').checked ? '1' : '0';

            fetch('/api/configs', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(async res => {
                const result = await res.json();
                if (!res.ok) {
                    throw new Error(result.detail || result.message || 'ä¿å­˜å¤±è´¥');
                }
                return result;
            })
            .then(res => {
                showToast('é…ç½®ä¿å­˜æˆåŠŸï¼');
                setTimeout(() => location.reload(), 1000);
            })
            .catch(err => {
                console.error(err);
                showToast(err.message, 'error');
            });
        }
    </script>
</body>
</html>
