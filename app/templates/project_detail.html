<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{{ project.name }} | é¡¹ç›®è¯¦æƒ…</title>
    <link rel="shortcut icon" href="{{ url_for('static',path='favicon.ico') }}" type="image/x-icon"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" type="text/css" media="all" href="{{ url_for('static',path='css/style.css') }}">
    <script src="{{ url_for('static',path='js/pagination.js') }}" defer></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="brand">
                <h1>X2T</h1>
            </div>
            <nav>
                <a href="{{ url_for('index') }}" class="nav-item">
                    <span class="icon">ğŸ </span> é¦–é¡µä»ªè¡¨ç›˜
                </a>
                <a href="{{ url_for('manage_projects') }}" class="nav-item active">
                    <span class="icon">ğŸ“‚</span> é¡¹ç›®ç®¡ç†
                </a>
                <a href="{{ url_for('manage_configs') }}" class="nav-item">
                    <span class="icon">âš™ï¸</span> ç³»ç»Ÿé…ç½®
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar" style="margin-bottom: 1.5rem; padding-bottom: 0.75rem;">
                <div style="margin-bottom: 0.5rem;">
                     <a href="{{ url_for('manage_projects') }}" style="color: var(--text-muted); font-size: 0.85rem; display: flex; align-items: center; gap: 0.25rem;">
                         <span>&larr;</span> è¿”å›é¡¹ç›®åˆ—è¡¨
                     </a>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div>
                        <h2 style="margin: 0;">{{ project.name }}</h2>
                        <p style="color: var(--text-muted); margin: 0.25rem 0 0 0; font-size: 0.9rem;">{{ project.description or 'æ— æè¿°' }}</p>
                    </div>
                </div>
            </header>

            <div class="content-wrapper">
                
                <!-- Quick Upload Card for this Project -->
                 <div class="card">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; border: none; padding: 0;">ä¸Šä¼ æ–‡ä»¶åˆ° {{ project.name }}</h3>
                        <a href="{{ url_for('static', path='guide/XMindæµ‹è¯•ç”¨ä¾‹æ¨¡æ¿.xmind') }}" download="XMindæµ‹è¯•ç”¨ä¾‹æ¨¡æ¿.xmind" style="font-size: 0.85rem; color: var(--primary-color); text-decoration: none; display: flex; align-items: center; gap: 0.25rem; font-weight: 500;">
                            ğŸ“¥ ä¸‹è½½æ¨¡æ¿
                        </a>
                     </div>
                    <form method="post" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" class="upload-form">
                        <input type="hidden" name="project_id" value="{{ project.id }}">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label for="case_type" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ç”¨ä¾‹ç±»å‹</label>
                                <select name="case_type" id="case_type" class="input-modern" style="width: 100%;">
                                    {% for ct in case_types %}
                                        <option value="{{ ct }}" {% if loop.first %}selected{% endif %}>{{ ct }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label for="apply_phase" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">é€‚ç”¨é˜¶æ®µ</label>
                                <select name="apply_phase" id="apply_phase" class="input-modern" style="width: 100%;">
                                    {% for ap in apply_phases %}
                                        <option value="{{ ap }}" {% if ap == 'åŠŸèƒ½æµ‹è¯•é˜¶æ®µ' %}selected{% elif loop.first and 'åŠŸèƒ½æµ‹è¯•é˜¶æ®µ' not in apply_phases %}selected{% endif %}>{{ ap }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <label id="file-label" for="file" style="border: 2px dashed #cbd5e1; padding: 2rem; border-radius: 8px; background: #f8fafc; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: all 0.2s;">
                            <span style="font-size: 1.5rem; margin-bottom: 0.5rem;">ğŸ“</span>
                            <span id="file-display-name">ç‚¹å‡»é€‰æ‹© .xmind æ–‡ä»¶</span>
                        </label>
                        <input id="file" accept=".xmind" type="file" name="file" class="hidden" required onchange="handleFileSelect(this)"/>
                        <input id="submit-btn" type="submit" value="è½¬æ¢å¹¶ä¸Šä¼ " class="btn-primary" style="width: 100%; margin-top: 1.5rem;"/>
                    </form>
                 </div>

                <!-- Project Files List -->
                <div class="card table-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">é¡¹ç›®æ–‡ä»¶åˆ—è¡¨</h3>
                        <div class="search-filter-bar">
                            <input type="text" id="fileSearchInput" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." class="search-input" onkeyup="filterFilesTable()" style="width: 200px;">
                        </div>
                    </div>
                    {% if records %}
                    <table class="modern-table">
                        <thead>
                            <tr style="font-size: 0.95rem;">
                                <th style="width: 50%;">æ–‡ä»¶å</th>
                                <th>æ—¶é—´</th>
                                <th class="text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="filesTableBody">
                            {% for record in records %}
                            <tr data-filename="{{ record.name }}">
                                <td title="{{ record.name }}">
                                    <span class="table-cell-text" style="font-weight: 500;">{{ record.short_name }}</span>
                                    {% if record.note %}
                                    <div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.2rem;">{{ record.note }}</div>
                                    {% endif %}
                                </td>
                                <td class="time-cell">{{ record.create_on }}</td>
                                <td class="text-right">
                                    <div class="action-buttons" style="justify-content: flex-end;">
                                        <a href="{{ url_for('preview_record', record_id=record.id) }}" 
                                           class="btn-action btn-action-preview" 
                                           title="åœ¨çº¿é¢„è§ˆ/ç¼–è¾‘">
                                            <span class="btn-icon">ğŸ‘ï¸</span>
                                            <span class="btn-text">é¢„è§ˆ</span>
                                        </a>

                                        {% if settings.ENABLE_ZENTAO %}
                                        <a href="{{ url_for('download_zentao_file',filename=record.name) }}" 
                                           class="btn-action" 
                                           title="å¯¼å‡ºç¦…é“ CSV">
                                            <span class="btn-icon">ğŸ“Š</span>
                                            <span class="btn-text">ç¦…é“</span>
                                        </a>
                                        {% endif %}
                                        {% if settings.ENABLE_TESTLINK %}
                                        <a href="{{ url_for('download_testlink_file',filename=record.name) }}" 
                                           class="btn-action" 
                                           title="å¯¼å‡º TestLink XML">
                                            <span class="btn-icon">ğŸ“„</span>
                                            <span class="btn-text">TestLink</span>
                                        </a>
                                        {% endif %}
                                        <a href="{{ url_for('download_xmind_file',filename=record.name) }}" 
                                           class="btn-action" 
                                           title="å¯¼å‡º XMind">
                                            <span class="btn-icon">ğŸ“¥</span>
                                            <span class="btn-text">XMind</span>
                                        </a>
                                        <button class="btn-action btn-action-delete" 
                                            data-id="{{ record.id }}"
                                            data-name="{{ record.name | e }}"
                                            onclick="deleteRecord(this.dataset.id, this.dataset.name)"
                                            title="åˆ é™¤è®°å½•">
                                            <span class="btn-icon">ğŸ—‘ï¸</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id="noFilesResults" style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);">
                        ğŸ˜• æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶
                    </div>
                    <!-- Pagination Container -->
                    <div id="filesTableBody-pagination"></div>
                    {% else %}
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        æš‚æ— æ–‡ä»¶ï¼Œè¯·åœ¨ä¸Šæ–¹ä¸Šä¼ ï¼
                    </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>
    
    <script>
    document.getElementById("file").addEventListener("change", function () {
        if (this.value) {
            document.getElementById("file-label").innerHTML = `
                <span style="color: var(--primary-color); font-weight: 600;">âœ… ${this.value.split("\\").pop()}</span>
            `;
            document.getElementById("file-label").style.borderColor = "var(--primary-color)";
            document.getElementById("file-label").style.background = "#eff6ff";
        }
    });

    // Initialize pagination
    let filesPagination = null;
    document.addEventListener('DOMContentLoaded', function() {
        const tbody = document.getElementById('filesTableBody');
        if (tbody && tbody.getElementsByTagName('tr').length > 0) {
            filesPagination = new Pagination({
                tableId: 'filesTableBody',
                itemsPerPage: 20
            });
            window.paginationInstances = window.paginationInstances || {};
            window.paginationInstances['filesTableBody'] = filesPagination;
        }
    });

    function filterFilesTable() {
        const input = document.getElementById("fileSearchInput");
        const filter = input.value.toLowerCase();
        const tbody = document.getElementById("filesTableBody");
        const rows = tbody.getElementsByTagName("tr");
        const noResults = document.getElementById("noFilesResults");
        let visibleCount = 0;
        const visibleRows = [];

        for (let row of rows) {
            const filename = row.getAttribute("data-filename").toLowerCase();
            if (filename.includes(filter)) {
                row.style.display = "";
                visibleCount++;
                visibleRows.push(row);
            } else {
                row.style.display = "none";
            }
        }

        if (visibleCount === 0) {
            tbody.parentElement.style.display = "none";
            noResults.style.display = "block";
        } else {
            tbody.parentElement.style.display = "table";
            noResults.style.display = "none";
        }
        
        // Refresh pagination
        if (filesPagination) {
            filesPagination.refresh(visibleRows);
        }
    }

    async function deleteRecord(id, name) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${name}" å—ï¼Ÿ\nåˆ é™¤åæ— æ³•æ¢å¤ã€‚`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/records/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Show success message and reload
                const toast = document.createElement('div');
                toast.className = 'toast toast-success show';
                toast.innerHTML = `<span class="toast-icon">âœ…</span> æ–‡ä»¶ "${name}" å·²åˆ é™¤`;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
        function handleFileSelect(input) {
        const displayName = document.getElementById('file-display-name');
        const fileLabel = document.getElementById('file-label');
        if (input.files && input.files.length > 0) {
            displayName.innerText = "å·²é€‰æ‹©: " + input.files[0].name;
            displayName.style.color = "var(--primary-color)";
            fileLabel.style.borderColor = "var(--primary-color)";
            fileLabel.style.background = "#eff6ff";
        }
    }
</script>
</body>
</html>
