<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é¡¹ç›®ç®¡ç† | Xmind2TestCase</title>
    <link rel="shortcut icon" href="{{ url_for('static',path='favicon.ico') }}" type="image/x-icon"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" type="text/css" media="all" href="{{ url_for('static',path='css/style.css') }}">
    <script src="{{ url_for('static',path='js/pagination.js') }}" defer></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="brand">
                <h1>X2T</h1>
            </div>
            <nav>
                <a href="{{ url_for('index') }}" class="nav-item">
                    <span class="icon">ğŸ </span> é¦–é¡µä»ªè¡¨ç›˜
                </a>
                <a href="{{ url_for('manage_projects') }}" class="nav-item active">
                    <span class="icon">ğŸ“‚</span> é¡¹ç›®ç®¡ç†
                </a>
                <a href="{{ url_for('manage_configs') }}" class="nav-item">
                    <span class="icon">âš™ï¸</span> ç³»ç»Ÿé…ç½®
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar" style="margin-bottom: 1.5rem; padding-bottom: 0.75rem;">
                <h2 style="margin: 0;">é¡¹ç›®ç®¡ç†</h2>
                <p style="color: var(--text-muted); margin: 0.25rem 0 0 0; font-size: 0.9rem;">åœ¨è¿™é‡Œç»Ÿä¸€ç®¡ç†æ‚¨çš„æ‰€æœ‰æµ‹è¯•é¡¹ç›®ï¼Œæ”¯æŒç¼–è¾‘å’ŒæŸ¥çœ‹é¡¹ç›®è¯¦æƒ…ã€‚</p>
            </header>

            <div class="content-wrapper">
                <!-- Project List -->
                <div class="card table-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.1rem;">é¡¹ç›®åˆ—è¡¨</h3>
                        <div class="search-filter-bar">
                            <input type="text" id="projectSearchInput" placeholder="ğŸ” æœç´¢é¡¹ç›®åç§°..." class="search-input" onkeyup="filterProjectsTable()" style="width: 200px;">
                        </div>
                    </div>
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th width="30%">åç§°</th>
                                <th width="40%">æè¿°</th>
                                <th width="20%">åˆ›å»ºæ—¶é—´</th>
                                <th class="text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="project-list-body">
                            {% for project in projects %}
                            <tr data-name="{{ project.name }}">
                                <td>
                                    <a href="{{ url_for('project_detail', project_id=project.id) }}" class="project-link">
                                        {{ project.name }}
                                    </a>
                                </td>
                                <td class="table-cell-text">{{ project.description or '-' }}</td>
                                <td>{{ project.create_on }}</td>
                                <td class="text-right">
                                    <div style="display: flex; justify-content: flex-end;">
                                        <button class="btn-icon edit-btn" 
                                            data-id="{{ project.id }}" 
                                            data-name="{{ project.name }}" 
                                            data-desc="{{ project.description or '' }}"
                                            onclick="openEditModal(this)"
                                            title="ç¼–è¾‘é¡¹ç›®">
                                            âœï¸
                                        </button>
                                    </div>
                                </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center">æš‚æ— é¡¹ç›®ï¼Œè¯·å…ˆåˆ›å»ºï¼</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                 </table>
                 <!-- Pagination Container -->
                 <div id="project-list-body-pagination"></div>
            </div>
            
            <!-- Edit Modal -->
            <div id="edit-modal" class="modal" onclick="closeEditModal()">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h2>âœï¸ ç¼–è¾‘é¡¹ç›®ä¿¡æ¯</h2>
                        <button class="modal-close" onclick="closeEditModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit-id">
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label style="display:block; margin-bottom: 0.5rem; font-weight: 600; color: #334155;">é¡¹ç›®åç§°</label>
                            <input type="text" id="edit-name" class="input-modern" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°">
                        </div>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label style="display:block; margin-bottom: 0.5rem; font-weight: 600; color: #334155;">é¡¹ç›®æè¿°</label>
                            <textarea id="edit-desc" class="input-modern" style="min-height: 100px; resize: vertical;" placeholder="è¯·è¾“å…¥é¡¹ç›®æè¿°..."></textarea>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                            <button onclick="closeEditModal()" class="btn-action" style="padding: 0.75rem 1.5rem;">å–æ¶ˆ</button>
                            <button onclick="saveEdit()" class="btn-primary" style="padding: 0.75rem 2rem;">ğŸš€ ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </main>
    </div>

<script>
    function showToast(message, type = 'success') {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
        }
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸' };
        toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><span class="toast-message">${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // é¡¹ç›®åˆ›å»ºç°å·²ç»Ÿä¸€é€šè¿‡â€œç³»ç»Ÿé…ç½®â€é¡µé¢è¿›è¡ŒåŒæ­¥ç®¡ç†ï¼Œæ— éœ€åœ¨æ­¤æ‰‹åŠ¨åˆ›å»º

    // é¡¹ç›®åˆ é™¤å·²è¢«ç¦ç”¨ï¼Œé¡¹ç›®ç®¡ç†è¯·é€šè¿‡â€œç³»ç»Ÿé…ç½®â€å…¥å£è¿›è¡Œ

    function openEditModal(btn) {
        const id = btn.dataset.id;
        const name = btn.dataset.name;
        const desc = btn.dataset.desc;
        
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-name').value = name;
        document.getElementById('edit-desc').value = desc;
        
        const modal = document.getElementById("edit-modal");
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("show"), 10);
    }

    function closeEditModal() {
        const modal = document.getElementById("edit-modal");
        modal.classList.remove("show");
        setTimeout(() => {
            modal.style.display = "none";
        }, 300);
    }

    function saveEdit() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('edit-name').value;
        const desc = document.getElementById('edit-desc').value;
        
        if (!name) return alert("è¯·è¾“å…¥é¡¹ç›®åç§°");

        fetch('/api/projects/' + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name, description: desc})
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') location.reload();
            else alert("æ›´æ–°å¤±è´¥");
        });
    }

    // Initialize pagination
    let projectsPagination = null;
    document.addEventListener('DOMContentLoaded', function() {
        const tbody = document.getElementById('project-list-body');
        if (tbody && tbody.getElementsByTagName('tr').length > 0) {
            projectsPagination = new Pagination({
                tableId: 'project-list-body',
                itemsPerPage: 20
            });
            window.paginationInstances = window.paginationInstances || {};
            window.paginationInstances['project-list-body'] = projectsPagination;
        }
    });

    function filterProjectsTable() {
        const input = document.getElementById("projectSearchInput");
        const filter = input.value.toLowerCase();
        const tbody = document.getElementById("project-list-body");
        const rows = tbody.getElementsByTagName("tr");
        const visibleRows = [];
        
        for (let row of rows) {
            const name = row.getAttribute("data-name");
            if (name) {
                if (name.toLowerCase().includes(filter)) {
                    row.style.display = "";
                    visibleRows.push(row);
                } else {
                    row.style.display = "none";
                }
            }
        }
        
        // Refresh pagination
        if (projectsPagination) {
            projectsPagination.refresh(visibleRows);
        }
    }
</script>
</body>
</html>
